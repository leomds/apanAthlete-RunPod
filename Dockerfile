# ======================================================================
# BASE IMAGE COM PYTORCH + CUDA 12.1 + cuDNN
# ======================================================================
FROM pytorch/pytorch:2.1.2-cuda12.1-cudnn8-runtime

# ======================================================================
# CONFIGURAÇÕES DO PYTHON
# ======================================================================
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# ======================================================================
# DEPENDÊNCIAS DO SISTEMA
# ======================================================================
RUN apt-get update && apt-get install -y \
    libgl1-mesa-glx \
    libglib2.0-0 \
    ffmpeg \
    wget \
    unzip \
    && rm -rf /var/lib/apt/lists/*

# ======================================================================
# DIRETÓRIO DE TRABALHO
# ======================================================================
WORKDIR /app

# ======================================================================
# INSTALA PRIMEIRO AS DEPENDÊNCIAS PYTHON
# (antes de copiar tudo, para cache eficiente)
# ======================================================================
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# ======================================================================
# COPIAR builder.py PARA PRÉ-DOWNLOAD DOS MODELOS
# ======================================================================
COPY builder.py .

# ======================================================================
# EXECUTAR O BUILDER PARA "ASSAR" OS MODELOS NA IMAGEM
# ======================================================================
RUN python builder.py

# ======================================================================
# COPIAR O RESTANTE DO PROJETO
# ======================================================================
COPY . .

# ======================================================================
# COMANDO FINAL – RUNPOD SERVERLESS
# ======================================================================
CMD ["python", "-u", "handler.py"]

